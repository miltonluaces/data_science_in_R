# Imports =====================================================================================================================================================

rm(list = ls()) 
path='Multivariate/R/'; setwd(path)
configPath = 'ConfigPath/'
library(MiscFunctions)
library(cluster)
library(FactoMineR)
library(lattice)
library(xlsx)
source(paste(path, 'MultivarLM.R', sep=''))
source(paste(path, 'MultivarNN.R', sep=''))
source(paste(path, 'Clustering.R', sep=''))
source(paste(path, 'MultivarTsLM.R', sep=''))
source(paste(path, 'MultivarTsNN.R', sep=''))
source(paste(path, 'PCA.R', sep=''))


# DATA SET ===========================================================================================================================================================================================

#cars = read.csv('Multivariate/inst/cars.csv', sep=';', stringsAsFactors = FALSE)
cars
cars[188,]
cars[,'fuel']
cars[cars$engSize < 100 & cars$engPos == 'front',]
cars[cars$price > 16515 , ]
carsSP = cars[,c(1,26)]
carsSH = cars[,c(1,22)]
carsSHP = cars[,c(1,22,26)]
colnames(cars)

TsUniData = read.xlsx('Multivariate/inst/Data.xls', sheetName='TsUnivariate')


# DATA EXPLORATION ===========================================================================================================================================================================================

pairs(sym~price+hp+wayAcc+cityAcc+rpm+length+width+height+curvHeight+engSize, data=cars, main='Data Exploration')

# sym ~ height, rpm

#carsSel = cars[,c('sym','height')]
carsSel = cars[,c('sym','rpm')]

scatter.smooth(carsSel, col='blue', lwd = 2, main = 'Paired data', xlab = 'Sym', ylab = 'Reg')
plot(density(cars$height), col='blue', main = 'Reg Density', xlab = 'Reg', ylab = 'Frequency', lwd = 3)
plot(density(cars$sym), col='blue', main = 'Sym Density', xlab = 'Sym', ylab = 'Frequency', lwd = 3)
cor(cars$sym, cars$rpm)

# LM: LINEAR MODELS FOR VARIABLES  ===========================================================================================================================================================================================

# Models _____________________________________________________________________________________________________________________________________________________________________________

lm.hei = lm(sym ~ height , data=cars); LMDiagnostics(lm.hei)
lm.rpm = lm(sym ~ rpm , data=cars); LMDiagnostics(lm.rpm)
lm.hr = lm(sym ~ height+rpm , data=cars); LMDiagnostics(lm.hr)

anova(lm.hei, lm.hr)

glm.hr = glm(sym ~ height+rpm, family=gaussian, data=cars)
summary(glm.hei)

anova(lm.hei, glm.hei)
AIC(lm.hei); AIC(lm.hr)

# Prediction _____________________________________________________________________________________________________________________________________________________________________________

values = list(height=c(48,52,55))
Predict(lm.hei, values, p=0.95)

values = list(height=c(48,52,55), rpm=c(4700,4900,5200))
Predict(lm.hr, values, p=0.95)

anova(lm.hei, lm.hr)

# NM: NEURAL NETWORKS MODELS FOR VARIABLES  ===========================================================================================================================================================================================

# Models _____________________________________________________________________________________________________________________________________________________________________________

sym.min = -3; sym.max = 3
sym.norm = Norm(cars$sym, sym.min, sym.max); sym.norm
sym = UnNorm(sym.norm, sym.min, sym.max); sym

nn.he = nnet(sym.norm ~ cars$height, size=2, linout=T,trace=F, decay = 0.8); nn.he
nn.rp = nnet(sym.norm ~ cars$rpm, size=2, linout=T,trace=F); nn.rp
nn.hr = nnet(sym.norm ~ cars$height + cars$rpm, size=2, linout=T,trace=F, decay=0.7); nn.hr

svm.hr = ksvm(sym.norm ~ cars$height+cars$rpm) 
summary(svm.hr)

# Prediction _____________________________________________________________________________________________________________________________________________________________________________

nn.pred = predict(nn.hr); 
summary(nn.pred)

nn.pred = predict(nn.hr, values=list(height=c(48,52,55), rpm=c(4700,4900,5200))); 
summary(nn.pred)

y = UnNorm(nn.pred, sym.min, sym.max); pred 
scatter.smooth(cars$sym, y, main="Neural network predictions vs actual", xlab="Actual")
cor.test(cars$sym, y)

svm.pred = predict(svm.hr, c(48,5500)); svm.pred

table(sym.norm, svm.pred)


# CLUSTERING  ===========================================================================================================================================================================================

# Models _____________________________________________________________________________________________________________________________________________________________________________

data = cars[,c('sym','height', 'rpm')]

ks = DetermineK(data,20)
k = GetK(ks, cut=50); k
#fit = kmeans(data, k)
fit = pam(data, k)

# Results _____________________________________________________________________________________________________________________________________________________________________________

centers = Centers(data, fit); centers
data = UpdateCluster(data, fit); data
cluster.stats(data, fit$cluster)
ClustPlot(data, fit)

# PCA ===========================================================================================================================================================================================

data = cars[,c('sym','height', 'rpm')]

pca = princomp(data, cor=TRUE)
summary(pca)
loadings(pca) 
GetResults(pca)

res = PCA(data)
res$var

# Plotting ===========================================================================================================================================================================================

barchart(data$sym ~ data$height, data=data, xlab='height', ylab='sym')
bwplot(data$sym ~ data$height, data=data, xlab='height', ylab='sym')
cloud(data$sym ~ data$height+data$rpm, data=data, zlab='sym', ylab='height', xlab='rpm')
dotplot(data$sym ~ data$height+data$rpm, data=data, zlab='sym', ylab='height', xlab='rpm')
levelplot(data$sym ~ data$height+data$rpm, data=data, zlab='sym', ylab='height', xlab='rpm')
scatterplot3d::scatterplot3d(data$sym, data$height, data$rpm, zlab='sym', ylab='height', xlab='rpm')
dataMatrix = data.matrix(data)
heatmap(dataMatrix)
persp(dataMatrix)
dataMatrix

a = c(1,3,6,9,2,4,9,3,4,12); b = c(22,31,65,92,21,44,19,23,84,112); c = c(11,33,66,39,22,14,99,43,24,8)
df = data.frame(a, b, c)
dataMatrix = data.matrix(df)

heatmap(dataMatrix)
persp(dataMatrix)
contour(dataMatrix)
rgl::plot3d(data)
ggplot2::qplot(height, rpm, data=data, facets=sym ~ ., xlab='height', ylab='rpm')


# Test NNFcst Univariate ===========================================================================================================================================================================================

rm(list = ls()) 
rm(Norm)
source('Multivariate/R/TDNN.R')
source('Multivariate/R/TDRNN.R')
source('Multivariate/R/NNFcst.R')
source('MiscFunctions/R/Norm.R')

ts = c(3.297703, 3.42274, 3.581779, 3.714642, 3.839385, 3.954643, 4.059192, 4.151958, 4.232039, 4.298715, 4.351458, 4.389942, 4.414043, 4.423848, 4.419645, 4.401929, 4.371383, 4.328881,
  4.275463, 4.212331, 4.140823, 4.062399, 3.978619, 3.891120, 3.801591, 3.711751, 3.623325, 3.538015, 3.457480, 3.383309, 3.317001, 3.259942, 3.213382, 3.178424, 3.156002, 3.146869,
  3.151589,3.170524,3.203835,3.251474,3.313186,3.388516,3.476812,3.577236,3.688773,3.810253,3.940358,4.077650,4.220585,4.367538,4.516828,4.666739,4.815547,4.961541,
  5.103055,5.238485,5.366313,5.485133,5.593668,5.690787,5.775526,5.847098,5.904903,5.948543,5.977822,5.992748,5.993541,5.980618,5.954599,5.916288,5.866668,5.806884,
  5.738228,5.662118,5.580081,5.493728,5.404733,5.314806,5.225673,5.139048,5.056607,4.979968,4.910665,4.850125,4.799652,4.760402,4.733372,4.719382,4.719064,4.732854,
  4.760987,4.803487,4.860177,4.930671,5.014388,5.110555,5.218220,5.336266,5.463427,5.598305)

ts2 = c(272.54545454545456, 11.478260869565217, 46.4, 59.086956521739133, 47.81818181818182, 26.80952380952381, 35.956521739130437, 40.0, 42.272727272727273, 21.0, 80.15, 245.52380952380952, 140.18181818181819, 148.36363636363637, 136.9047619047619, 191.0, 409.61904761904759, 190.36363636363637, 185.7391304347826, 488.4, 109.56521739130434, 34.909090909090907, 40.8, 80.727272727272734, 306.54545454545456, 126.85714285714286)

ts3 = c(30.61538461538461, 9.777777777777779, 37.12, 50.333333333333336, 38.962962962962962, 22.52, 30.62962962962963, 32.307692307692307, 35.769230769230766, 17.888888888888889, 66.791666666666671, 198.30769230769232, 118.61538461538461, 120.88888888888889, 115.0, 162.7037037037037, 330.84615384615387, 161.07692307692307, 158.22222222222223, 390.72, 93.333333333333329, 28.444444444444443, 34.0, 68.3076923076923, 259.38461538461536, 102.46153846153847)

ts4 = c(13.0, 0.0, 0.0, 287.13043478260869, 205.3, 542.73913043478262, 239.18181818181819, 271.23809523809524, 485.30434782608694, 342.09523809523807, 255.0, 322.0, 365.3, 326.33333333333331, 457.77272727272725, 529.13636363636363, 392.47619047619048, 414.91304347826087, 309.57142857142856, 952.5, 814.39130434782612, 508.2, 645.52173913043475, 686.27272727272725, 785.8, 975.5, 718.18181818181813, 688.71428571428567)

ts5 = c(10.833333333333334, 0.0, 0.0, 244.59259259259258, 140.76, 444.92592592592592, 168.62962962962962, 207.32, 377.25925925925924, 244.61538461538461, 197.5, 246.07407407407408, 238.41666666666666, 222.07692307692307, 326.84615384615387, 410.88888888888891, 279.16, 293.33333333333331, 194.23076923076923, 721.23076923076928, 571.55555555555554, 377.28, 435.14814814814815, 361.77777777777777, 518.0, 589.92307692307691, 383.07692307692309, 360.80769230769232)

tdnn = TDNN$new(ts, mw=6, nHidden=12, dec=0.001, range=0.5, maxIt=6000)
fcst = tdnn$Forecast(horizon=12, it=1); fcst 
PlotSeries(ts, fcst)

ts=ts5
NNFcstUniInit(ts, mw=6, nHidden=18, dec=0.01, range=0.5, maxIt=6000)
fcst = NNFcstUniFcst(horizon=12,it=5); fcst
PlotSeries(ts, fcst)


# Test NNFcst Multivariate ===========================================================================================================================================================================================

ts = c(3.297703, 3.442274, 3.581779, 3.714642, 3.839385, 3.954643, 4.059192, 4.151958, 4.232039, 4.298715, 4.351458, 4.389942, 4.414043, 4.423848, 4.419645, 4.401929, 4.371383, 4.328881,
       4.275463, 4.212331, 4.140823, 4.062399, 3.978619, 3.891120, 3.801591, 3.711751, 3.623325, 3.538015, 3.457480, 3.383309, 3.317001, 3.259942, 3.213382, 3.178424, 3.156002, 3.146869,
       3.151589,3.170524,3.203835,3.251474,3.313186,3.388516,3.476812,3.577236,3.688773,3.810253,3.940358,4.077650,4.220585,4.367538,4.516828,4.666739,4.815547,4.961541,
       5.103055,5.238485,5.366313,5.485133,5.593668,5.690787,5.775526,5.847098,5.904903,5.948543,5.977822,5.992748,5.993541,5.980618,5.954599,5.916288,5.866668,5.806884,
       5.738228,5.662118,5.580081,5.493728,5.404733,5.314806,5.225673,5.139048,5.056607,4.979968,4.910665,4.850125,4.799652,4.760402,4.733372,4.719382,4.719064,4.732854,
       4.760987,4.803487,4.860177,4.930671,5.014388,5.110555,5.218220,5.336266,5.463427,5.598305)

reg1 = c(10,10,10,10,10,20,20,20,10,10,10,10,10,10,20,20,20,10,10,10,10,10,10,10,10,10,10,30,30,30,30,30,10,10,10,10,10,10,10,10,40,40,40,40,40,10,10,10
         ,10,10,10,10,10,10,10,10,10,10,20,20,20,20,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,30,30,30,30,30,30,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10)

tsReg = c(3.297703,3.442274,3.581779,3.714642,3.839385,4.954643,5.059192,5.151958,4.232039,4.298715,4.351458,4.389942,4.414043,4.423848,5.419645,5.401929
          ,5.371383,4.328881,4.275463,4.212331,4.140823,4.062399,3.978619,3.891120,3.801591,3.711751,3.623325,5.538015,5.457480,5.383309,5.317001,5.259942
          ,3.213382,3.178424,3.156002,3.146869,3.151589,3.170524,3.203835,3.251474,6.313186,6.388516,6.476812,6.577236,6.688773,3.810253,3.940358,4.077650
          ,4.220585,4.367538,4.516828,4.666739,4.815547,4.961541,5.103055,5.238485,5.366313,5.485133,6.593668,6.690787,6.775526,6.847098,5.904903,5.948543
          ,5.977822,5.992748,5.993541,5.980618,5.954599,5.916288,5.866668,5.806884,5.738228,5.662118,5.580081,5.493728,5.404733,5.314806,5.225673,7.139048
          ,7.056607,6.979968,6.910665,6.850125,6.799652,4.760402,4.733372,4.719382,4.719064,4.732854,4.760987,4.803487,4.860177,4.930671,5.014388,5.110555,5.218220,5.336266,5.463427,5.598305)

reg1Fcst = c(10, 10, 30, 30, 10, 10, 10, 10, 10, 10, 10, 10)

NNFcstMultiInit(ts, reg1)
fcst = NNFcstMultiFcst(horizon=12,it=1, reg1Fcst); fcst
